<@>Topaz = import(module:'Topaz.Core');
<@>class = import(module:'Matte.Core.Class');
<@>TOPAZ = import(module:'Topaz.Constants');
<@>Emitter = class(info:{
    inherits : [Topaz.Entity],
    define ::(this) {
        <@>emitter = Topaz.ParticleEmitter2D.new();    

        @a = Topaz.Automation.new();
        a.addKeyframe(value:0,   function:TOPAZ.AUTOMATION.FUNCTION.SQUARE_ROOT, offset:0);
        a.addKeyframe(value:0.5, function:TOPAZ.AUTOMATION.FUNCTION.SQUARE_ROOT, offset:0.5);
        a.addKeyframe(value:1,   function:TOPAZ.AUTOMATION.FUNCTION.SQUARE_ROOT, offset:1);
        @ramp01 = a.string;
        a.clear();
        a.addKeyframe(value:1, function:TOPAZ.AUTOMATION.FUNCTION.NONE, offset:0);
        a.addKeyframe(value:1, function:TOPAZ.AUTOMATION.FUNCTION.NONE, offset:1);
        @stable1 = a.string;
        a.clear();
        a.addKeyframe(value:0, function:TOPAZ.AUTOMATION.FUNCTION.LINEAR,   offset:0);
        a.addKeyframe(value:360, function:TOPAZ.AUTOMATION.FUNCTION.LINEAR, offset:1);
        @ramp360 = a.string;
        a.clear();
        a.addKeyframe(value:1,   function:TOPAZ.AUTOMATION.FUNCTION.SQUARE_ROOT, offset:0);
        a.addKeyframe(value:0.5, function:TOPAZ.AUTOMATION.FUNCTION.SQUARE_ROOT, offset:0.5);
        a.addKeyframe(value:0,   function:TOPAZ.AUTOMATION.FUNCTION.SQUARE_ROOT, offset:1);
        @ramp10 = a.string;
        a.clear();
        a.addKeyframe(value:10, function:TOPAZ.AUTOMATION.FUNCTION.SQUARE_ROOT, offset:0);
        a.addKeyframe(value:5,  function:TOPAZ.AUTOMATION.FUNCTION.SQUARE_ROOT, offset:0.5);
        a.addKeyframe(value:0,  function:TOPAZ.AUTOMATION.FUNCTION.SQUARE_ROOT, offset:1);
        @ramp100 = a.string;
        
        
        Topaz.Resources.loadAsset(extension:'png', path:'base.png', name:'example');


        @particle = Topaz.Particle.new();
        particle.image = 'example';

        particle.setAttribute(attribute:TOPAZ.RENDERER.ATTRIBUTE.ALPHA_RULE,  value:TOPAZ.RENDERER.ALPHA_RULE.ALLOW);
        particle.setAttribute(attribute:TOPAZ.RENDERER.ATTRIBUTE.ETCH_RULE,   value:TOPAZ.RENDERER.ETCH_RULE.NOETCHING);
        particle.setAttribute(attribute:TOPAZ.RENDERER.ATTRIBUTE.DEPTH_TEST, value: TOPAZ.RENDERER.DEPTH_TEST.NONE);
        particle.setAttribute(attribute:TOPAZ.RENDERER.ATTRIBUTE.TEXTURE_FILTER_HINT, value:TOPAZ.RENDERER.TEXTURE_FILTER_HINT.LINEAR);

        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.SCALE_X, value:ramp01);
        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.SCALE_Y, value:ramp01);
        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.SPEED_X, value:ramp100);
        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.SPEED_Y, value:ramp100);
        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.SCALE_MULTIPLIER, value:stable1);
        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.DIRECTION, value:ramp360);
        //particle.setFunction(TOPAZ.PARTICLE.PROPERTY.Rotation, ramp01);
        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.RED,   value:stable1);
        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.GREEN, value:stable1);
        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.BLUE,  value:stable1);
        particle.setFunction(property:TOPAZ.PARTICLE.PROPERTY.ALPHA, value:ramp10);

        //particle.setNoiseMin(TOPAZ.PARTICLE.PROPERTY.SpeedX, 0.4);
        //particle.setNoiseMax(TOPAZ.PARTICLE.PROPERTY.SpeedX, 5);
        //particle.setNoiseMin(TOPAZ.PARTICLE.PROPERTY.SpeedY, 0.4);
        //particle.setNoiseMax(TOPAZ.PARTICLE.PROPERTY.SpeedY, 5);

        particle.setNoiseMin(property:TOPAZ.PARTICLE.PROPERTY.SCALE_MULTIPLIER, value:10);
        particle.setNoiseMax(property:TOPAZ.PARTICLE.PROPERTY.SCALE_MULTIPLIER, value:14);


        particle.setNoiseMin(property:TOPAZ.PARTICLE.PROPERTY.DURATION, value:1);
        particle.setNoiseMin(property:TOPAZ.PARTICLE.PROPERTY.DURATION, value:100);

        particle.setNoiseMin(property:TOPAZ.PARTICLE.PROPERTY.DIRECTION, value:0);
        particle.setNoiseMin(property:TOPAZ.PARTICLE.PROPERTY.DIRECTION, value:356);



        particle.setNoiseMin(property:TOPAZ.PARTICLE.PROPERTY.RED, value:0);
        particle.setNoiseMax(property:TOPAZ.PARTICLE.PROPERTY.RED, value:1);



        // FIXME
        emitter.particle = particle;
        
        this.attach(entity:emitter);

        this.onStep = :: {
            emitter.emit(amount:1);
        };
    }
});


@v = Emitter.new();
v.position = {x:200, y:200};
Topaz.root = v;
